<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration - Itjen Kementerian Transmigrasi RI</title>
    
    <!-- Favicon dan Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="logo/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo/logo.png">
    <link rel="shortcut icon" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="144x144" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="114x114" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="60x60" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="57x57" href="logo/logo.png">
    
    <!-- Meta Tags untuk Social Media dan WhatsApp -->
    <meta name="description" content="User Registration - Pendaftaran pengguna baru untuk sistem monitoring Inspektorat Jenderal Kementerian Transmigrasi. Daftar untuk mengakses platform monitoring program dan anggaran.">
    <meta name="keywords" content="User Registration, Registrasi, Itjen, Inspektorat Jenderal, Kementerian Transmigrasi, Sign Up, Daftar">
    <meta name="author" content="Inspektorat Jenderal Kementerian Transmigrasi">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:title" content="User Registration - Itjen Kementerian Transmigrasi RI">
    <meta property="og:description" content="Pendaftaran pengguna baru untuk sistem monitoring Inspektorat Jenderal Kementerian Transmigrasi.">
    <meta property="og:image" content="logo/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Itjen Kementerian Transmigrasi RI">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="">
    <meta property="twitter:title" content="User Registration - Itjen Kementerian Transmigrasi RI">
    <meta property="twitter:description" content="Pendaftaran pengguna baru untuk sistem monitoring.">
    <meta property="twitter:image" content="logo/logo.png">
    
    <!-- WhatsApp Meta Tags -->
    <meta property="og:image:alt" content="Logo Inspektorat Jenderal Kementerian Transmigrasi">
    <meta name="thumbnail" content="logo/logo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #3498db;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group input.required,
        .form-group select.required {
            border-color: #e74c3c;
        }

        .form-group input.required:focus,
        .form-group select.required:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .required-field {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .role-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .role-info h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }

        .role-info ul {
            color: #0c5460;
            padding-left: 20px;
        }

        .role-info li {
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .close-alert {
            float: right;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close-alert:hover {
            color: #000;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>👤 User Registration</h1>
            <p>Kementerian Transmigrasi - Pendaftaran User Baru</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-text">Progress: <span id="progressPercent">0%</span></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Alerts -->
        <div id="alertSuccess" class="alert alert-success">
            <span class="close-alert" onclick="closeAlert('alertSuccess')">&times;</span>
            <strong>Success!</strong> <span id="successMessage"></span>
        </div>
        <div id="alertError" class="alert alert-error">
            <span class="close-alert" onclick="closeAlert('alertError')">&times;</span>
            <strong>Error!</strong> <span id="errorMessage"></span>
        </div>
        <div id="alertInfo" class="alert alert-info">
            <span class="close-alert" onclick="closeAlert('alertInfo')">&times;</span>
            <strong>Info:</strong> <span id="infoMessage"></span>
        </div>

        <!-- Registration Form -->
        <form id="registrationForm">
            <!-- Personal Information -->
            <div class="form-section">
                <h3>👤 Informasi Pribadi</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Nama Depan *</label>
                        <input type="text" id="firstName" class="required" required>
                        <div class="required-field">* Wajib diisi</div>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nama Belakang *</label>
                        <input type="text" id="lastName" class="required" required>
                        <div class="required-field">* Wajib diisi</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" class="required" required>
                        <div class="required-field">* Wajib diisi</div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Nomor Telepon</label>
                        <input type="tel" id="phone" placeholder="08123456789">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nip">NIP</label>
                        <input type="text" id="nip" placeholder="198501012010011001">
                    </div>
                    <div class="form-group">
                        <label for="jabatan">Jabatan</label>
                        <input type="text" id="jabatan" placeholder="Kepala Seksi">
                    </div>
                </div>
            </div>

            <!-- Role & Access -->
            <div class="form-section">
                <h3>🔐 Role & Akses</h3>
                <div class="form-group full-width">
                    <label for="role">Pilih Role *</label>
                    <select id="role" class="required" required onchange="showRoleInfo()">
                        <option value="">Pilih Role</option>
                        <option value="super_admin">👑 Super Admin</option>
                        <option value="admin">👨‍💼 Admin Satuan Kerja</option>
                        <option value="user">👤 User</option>
                        <option value="viewer">👁️ Viewer</option>
                    </select>
                    <div class="required-field">* Wajib diisi</div>
                </div>
                
                <div id="roleInfo" class="role-info" style="display: none;">
                    <!-- Role information will be populated here -->
                </div>
            </div>

            <!-- Satuan Kerja -->
            <div class="form-section">
                <h3>🏢 Satuan Kerja</h3>
                <div class="form-group full-width">
                    <label for="satuanKerja">Satuan Kerja *</label>
                    <select id="satuanKerja" class="required" required>
                        <option value="">Pilih Satuan Kerja</option>
                        <!-- Will be populated with satuan kerja data -->
                    </select>
                    <div class="required-field">* Wajib diisi</div>
                </div>
            </div>

            <!-- Location -->
            <div class="form-section">
                <h3>📍 Lokasi</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="provinsi">Provinsi</label>
                        <select id="provinsi" onchange="updateKabupaten()">
                            <option value="">Pilih Provinsi</option>
                            <!-- Will be populated with province data -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="kabupaten">Kabupaten/Kota</label>
                        <select id="kabupaten">
                            <option value="">Pilih Kabupaten/Kota</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="form-section">
                <h3>📝 Informasi Tambahan</h3>
                <div class="form-group full-width">
                    <label for="notes">Catatan</label>
                    <textarea id="notes" rows="3" placeholder="Catatan tambahan atau informasi khusus..."></textarea>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn" id="submitBtn">
                🚀 Daftar User Baru
            </button>
        </form>

        <!-- Navigation -->
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="window.location.href='user-management.html'">
                🔙 Kembali ke User Management
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcetwoMXOnXuU60WSaUaUce-g1GVSDmWE",
            authDomain: "dashboard-kementrans.firebaseapp.com",
            projectId: "dashboard-kementrans",
            storageBucket: "dashboard-kementrans.firebasestorage.app",
            messagingSenderId: "852941680228",
            appId: "1:852941680228:web:57f9502b71e246ea8e7971",
            measurementId: "G-MRMNSD561Q"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Master data
        const satuanKerjaData = [
            // Tingkat Pusat (Kementerian)
            "Biro Perencanaan, Kerjasama, dan Hubungan Masyarakat",
            "Biro Umum dan Layanan Pengadaan",
            "Biro Keuangan dan BMN",
            "Biro Organisasi, SDM, dan Reformasi Birokrasi",
            "Biro Hukum",
            
            // Tingkat Pusat (Pusat)
            "Pusat Strategi Kebijakan Transmigrasi",
            "Pusat Data dan Informasi Transmigrasi",
            "Pusat Pengembangan SDM",
            
            // Tingkat Pusat (Direktorat)
            "Direktorat Perencanaan Perwujudan Kawasan Transmigrasi",
            "Direktorat Pembangunan Kawasan Transmigrasi",
            "Direktorat Fasilitasi Penataan Persebaran Penduduk di Kawasan Transmigrasi",
            "Direktorat Pengembangan Satuan Permukiman dan Pusat Satuan Kawasan Pengembangan",
            "Direktorat Pengembangan Kawasan Transmigrasi",
            "Direktorat Perencanaan Teknis Pengembangan Ekonomi dan Pemberdayaan Masyarakat Transmigrasi",
            "Direktorat Pengembangan Kelembagaan Ekonomi Transmigrasi",
            "Direktorat Pengembangan Produk Unggulan Transmigrasi",
            "Direktorat Promosi dan Pemasaran Produk Unggulan Transmigrasi",
            "Direktorat Pemberdayaan Masyarakat Transmigrasi",
            
            // Tingkat Pusat (Inspektorat)
            "Sekretariat Itjen",
            "Inspektorat I",
            "Inspektorat II"
        ];

        const provinceData = [
            "Aceh", "Sumatera Utara", "Sumatera Barat", "Riau", "Jambi", "Sumatera Selatan",
            "Bengkulu", "Lampung", "Bangka Belitung", "Kepulauan Riau", "DKI Jakarta",
            "Jawa Barat", "Jawa Tengah", "DI Yogyakarta", "Jawa Timur", "Banten", "Bali",
            "Nusa Tenggara Barat", "Nusa Tenggara Timur", "Kalimantan Barat", "Kalimantan Tengah",
            "Kalimantan Selatan", "Kalimantan Timur", "Kalimantan Utara", "Sulawesi Utara",
            "Gorontalo", "Sulawesi Tengah", "Sulawesi Barat", "Sulawesi Selatan", "Sulawesi Tenggara",
            "Maluku", "Maluku Utara", "Papua", "Papua Barat"
        ];

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            populateDropdowns();
            setupFormValidation();
            updateProgress();
        });

        // Populate dropdowns
        function populateDropdowns() {
            // Populate satuan kerja dropdown
            const satkerSelect = document.getElementById('satuanKerja');
            satkerSelect.innerHTML = '<option value="">Pilih Satuan Kerja</option>';
            satuanKerjaData.forEach(satker => {
                const option = document.createElement('option');
                option.value = satker;
                option.textContent = satker;
                satkerSelect.appendChild(option);
            });

            // Populate province dropdown
            const provinceSelect = document.getElementById('provinsi');
            provinceSelect.innerHTML = '<option value="">Pilih Provinsi</option>';
            provinceData.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        }

        // Setup form validation
        function setupFormValidation() {
            const form = document.getElementById('registrationForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('input', updateProgress);
                input.addEventListener('change', updateProgress);
            });

            form.addEventListener('submit', handleRegistration);
        }

        // Update progress bar
        function updateProgress() {
            const requiredFields = document.querySelectorAll('.required');
            const filledFields = Array.from(requiredFields).filter(field => field.value.trim() !== '');
            const progress = (filledFields.length / requiredFields.length) * 100;
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
        }

        // Show role information
        window.showRoleInfo = function() {
            const role = document.getElementById('role').value;
            const roleInfo = document.getElementById('roleInfo');
            
            if (!role) {
                roleInfo.style.display = 'none';
                return;
            }

            const roleDescriptions = {
                'super_admin': {
                    title: '👑 Super Admin',
                    description: 'Akses penuh ke semua fitur sistem',
                    permissions: [
                        'Mengelola semua user dan role',
                        'Akses ke semua data dan laporan',
                        'Konfigurasi sistem',
                        'Backup dan restore data'
                    ]
                },
                'admin': {
                    title: '👨‍💼 Admin Satuan Kerja',
                    description: 'Mengelola user dan data dalam satuan kerjanya',
                    permissions: [
                        'Mengelola user dalam satuan kerjanya',
                        'Akses ke data satuan kerjanya',
                        'Generate laporan internal',
                        'Update informasi satuan kerja'
                    ]
                },
                'user': {
                    title: '👤 User',
                    description: 'Input dan update data progress',
                    permissions: [
                        'Input data progress fisik & keuangan',
                        'Update data yang sudah ada',
                        'Lihat data satuan kerjanya',
                        'Generate laporan personal'
                    ]
                },
                'viewer': {
                    title: '👁️ Viewer',
                    description: 'Hanya dapat melihat data (read-only)',
                    permissions: [
                        'Lihat data progress',
                        'Lihat laporan dan dashboard',
                        'Tidak dapat mengubah data',
                        'Export data untuk analisis'
                    ]
                }
            };

            const roleData = roleDescriptions[role];
            if (roleData) {
                roleInfo.innerHTML = `
                    <h4>${roleData.title}</h4>
                    <p>${roleData.description}</p>
                    <h5>Hak Akses:</h5>
                    <ul>
                        ${roleData.permissions.map(permission => `<li>${permission}</li>`).join('')}
                    </ul>
                `;
                roleInfo.style.display = 'block';
            }
        };

        // Update kabupaten options
        window.updateKabupaten = function() {
            const selectedProvince = document.getElementById('provinsi').value;
            const kabupatenSelect = document.getElementById('kabupaten');
            
            kabupatenSelect.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
            
            if (selectedProvince) {
                // This would need to be populated with actual kabupaten data
                // For now, we'll add some placeholder options
                const kabupatenOptions = [
                    'Pilih Kabupaten/Kota',
                    'Kabupaten A',
                    'Kabupaten B', 
                    'Kota C',
                    'Kabupaten D',
                    'Kota E'
                ];
                
                kabupatenOptions.forEach(kabupaten => {
                    const option = document.createElement('option');
                    option.value = kabupaten;
                    option.textContent = kabupaten;
                    kabupatenSelect.appendChild(option);
                });
            }
        };

        // Handle registration
        async function handleRegistration(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ Processing...';
            
            try {
                // Validate required fields
                const requiredFields = document.querySelectorAll('.required');
                const missingFields = Array.from(requiredFields).filter(field => field.value.trim() === '');
                
                if (missingFields.length > 0) {
                    showAlert('error', 'Mohon lengkapi semua field yang wajib diisi');
                    return;
                }

                // Collect form data
                const formData = {
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    nip: document.getElementById('nip').value.trim(),
                    jabatan: document.getElementById('jabatan').value.trim(),
                    role: document.getElementById('role').value,
                    satuanKerja: document.getElementById('satuanKerja').value,
                    provinsi: document.getElementById('provinsi').value,
                    kabupaten: document.getElementById('kabupaten').value,
                    notes: document.getElementById('notes').value.trim(),
                    createdAt: new Date().toISOString(),
                    status: 'pending_approval'
                };

                // Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(
                    auth, 
                    formData.email, 
                    generateTemporaryPassword()
                );

                // Update user profile
                await updateProfile(userCredential.user, {
                    displayName: `${formData.firstName} ${formData.lastName}`
                });

                // Save user data to Firestore
                const userDocRef = doc(db, 'users', userCredential.user.uid);
                await setDoc(userDocRef, {
                    ...formData,
                    uid: userCredential.user.uid,
                    displayName: `${formData.firstName} ${formData.lastName}`,
                    isActive: false, // Requires admin approval
                    approvedBy: null,
                    approvedAt: null
                });

                // Show success message
                showAlert('success', 'User berhasil didaftarkan! Silakan tunggu approval dari admin.');
                
                // Reset form
                document.getElementById('registrationForm').reset();
                updateProgress();
                
                // Redirect to user management after 3 seconds
                setTimeout(() => {
                    window.location.href = 'user-management.html';
                }, 3000);

            } catch (error) {
                console.error('Registration error:', error);
                showAlert('error', `Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '🚀 Daftar User Baru';
            }
        }

        // Generate temporary password
        function generateTemporaryPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Show alert
        function showAlert(type, message) {
            const alertElement = document.getElementById(`alert${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const messageElement = document.getElementById(`${type}Message`);
            
            if (alertElement && messageElement) {
                messageElement.textContent = message;
                alertElement.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
        }

        // Close alert
        window.closeAlert = function(alertId) {
            document.getElementById(alertId).style.display = 'none';
        };
    </script>
</body>
</html>
