<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Dashboard - Monitoring Program dan Anggaran - Itjen Kementerian Transmigrasi RI</title>
    
    <!-- Favicon dan Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="logo/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo/logo.png">
    <link rel="shortcut icon" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="144x144" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="114x114" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="60x60" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="57x57" href="logo/logo.png">
    
    <!-- Meta Tags untuk Social Media dan WhatsApp -->
    <meta name="description" content="Progress Dashboard - Monitoring dan tracking progress kegiatan program Inspektorat Jenderal Kementerian Transmigrasi. Dashboard detail untuk memantau realisasi anggaran dan progress fisik.">
    <meta name="keywords" content="Progress Dashboard, Itjen, Inspektorat Jenderal, Kementerian Transmigrasi, Monitoring, Progress, Kegiatan, Anggaran">
    <meta name="author" content="Inspektorat Jenderal Kementerian Transmigrasi">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:title" content="Progress Dashboard - Itjen Kementerian Transmigrasi RI">
    <meta property="og:description" content="Progress Dashboard - Monitoring dan tracking progress kegiatan program Inspektorat Jenderal Kementerian Transmigrasi.">
    <meta property="og:image" content="logo/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Itjen Kementerian Transmigrasi RI">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="">
    <meta property="twitter:title" content="Progress Dashboard - Itjen Kementerian Transmigrasi RI">
    <meta property="twitter:description" content="Dashboard detail untuk memantau realisasi anggaran dan progress fisik kegiatan program.">
    <meta property="twitter:image" content="logo/logo.png">
    
    <!-- WhatsApp Meta Tags -->
    <meta property="og:image:alt" content="Logo Inspektorat Jenderal Kementerian Transmigrasi">
    <meta name="thumbnail" content="logo/logo.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        /* Navigation Bar */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: #1e293b;
        }

        .navbar-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .navbar-title {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn-outline {
            background: transparent;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-outline:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-1px);
        }

        .btn-outline.success {
            color: #10b981;
            border-color: #10b981;
        }

        .btn-outline.success:hover {
            background: #10b981;
            color: white;
        }

        .btn-outline.danger {
            color: #ef4444;
            border-color: #ef4444;
        }

        .btn-outline.danger:hover {
            background: #ef4444;
            color: white;
        }

        .navbar .user-info {
            text-align: right;
        }

        .navbar .user-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9rem;
        }

        .user-satker {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Filters */
        .filters {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.10);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .filters h3 {
            color: #1e293b;
            margin-bottom: 16px;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        /* Data Container */
        .data-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.10);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .data-actions {
            display: flex;
            gap: 12px;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.12);
        }

        .btn-info:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.10);
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1e40af;
            font-size: 1.875rem;
            font-weight: 700;
        }

        /* REMOVED DUPLICATE .user-info CSS - ONLY USE NAVBAR VERSION */

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
        }

        .stat-card h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .stat-card .breakdown {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }
        
        .stat-card .breakdown small {
            color: #6b7280;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        
        .stat-card .method-indicator {
            margin-top: 4px;
        }
        
        .stat-card .method-indicator small {
            color: #6b7280;
            font-size: 0.75rem;
            font-style: italic;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            min-width: 160px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            text-align: left;
            color: #374151;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
            transform: none;
            box-shadow: none;
        }

        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .dropdown-item i {
            width: 16px;
            color: #6b7280;
        }

        /* View Modal Styles */
        .view-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 0;
        }

        .view-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }

        .view-section h5 {
            margin: 0 0 16px 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .view-header h4 {
            margin: 0;
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
            flex: 1;
        }

        .view-badges {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #10b981;
            color: white;
        }

        .badge.secondary {
            background: #6b7280;
        }

        .view-subtitle {
            margin: 0;
            color: #6b7280;
            font-size: 0.95rem;
            font-style: italic;
        }

        .progress-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .progress-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .progress-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 600;
        }

        .view-text-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 12px;
        }

        .info-text {
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Responsive adjustments for view modal */
        @media (max-width: 768px) {
            .progress-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .view-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .view-badges {
                align-self: stretch;
            }
        }

        .search-box {
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        tr:hover {
            background: #f8fafc;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .action-btn.edit { background: #f59e0b; color: white; }
        .action-btn.delete { background: #ef4444; color: white; }
        .action-btn.view { background: #10b981; color: white; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .message {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #d1d5db;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { flex-direction: column; gap: 15px; }
            .controls { flex-direction: column; align-items: stretch; }
            .search-box { max-width: none; }
            .stats-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; padding: 20px; margin: 20px; }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="executive-dashboard.html" class="navbar-brand">
                <div class="navbar-icon">
                    <img src="logo/logo.png" alt="Logo Inspektorat Jenderal" style="width: 100%; height: 100%; object-fit: contain; border-radius: var(--radius-md);">
                </div>
                <div class="navbar-title">Dashboard Progress</div>
            </a>
            
            <div class="navbar-actions">
                <a href="form-progress-kegiatan.html" class="btn-outline success">
                    <i class="fas fa-plus"></i>
                    <span>Tambah Data</span>
                </a>
                <a href="executive-dashboard.html" class="btn-outline">
                    <i class="fas fa-home"></i>
                    <span>Executive Dashboard</span>
                </a>
                <button onclick="logout()" class="btn-outline danger">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-satker" id="userSatker">Loading...</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header fade-in-up">
            <h1><i class="fas fa-chart-bar"></i> Dashboard Progress Kegiatan</h1>
            <p>Monitoring dan pelaporan progress fisik & keuangan kegiatan satuan kerja</p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Kegiatan</h3>
                <div class="value" id="totalKegiatan">0</div>
                <div class="breakdown">
                    <small>Sudah Kontrak: <span id="kegiatanSudahKontrak">0</span></small><br>
                    <small>Belum Kontrak: <span id="kegiatanBelumKontrak">0</span></small>
                </div>
            </div>
            <div class="stat-card">
                <h3>Progress Rate</h3>
                <div class="value" id="avgProgress">0%</div>
                <div class="method-indicator">
                    <small id="progressMethod">Dari nilai kontrak</small>
                </div>
            </div>
            <div class="stat-card">
                <h3>Pagu Anggaran</h3>
                <div class="value" id="totalAnggaran">Rp 0</div>
                </div>
            <div class="stat-card">
                <h3>Total Kontrak</h3>
                <div class="value" id="totalKontrak">Rp 0</div>
                <div class="breakdown">
                    <small id="kontrakStatus">Kegiatan berkontrak</small>
            </div>
                </div>
            <div class="stat-card">
                <h3>Realisasi</h3>
                <div class="value" id="totalRealisasi">Rp 0</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters fade-in-up" style="animation-delay: 0.5s;">
            <h3><i class="fas fa-filter"></i> Filter & Pencarian</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Cari Kegiatan</label>
                    <input type="text" id="searchInput" placeholder="Nama kegiatan atau paket..." onkeyup="filterData()">
                </div>
                <div class="filter-group">
                    <label>Progress Fisik</label>
                    <select id="progressFilter" onchange="filterData()">
                        <option value="">Semua Progress</option>
                        <option value="0">Belum Mulai (0%)</option>
                        <option value="1-25">Tahap Awal (1-25%)</option>
                        <option value="26-50">Tahap Menengah (26-50%)</option>
                        <option value="51-75">Tahap Lanjut (51-75%)</option>
                        <option value="76-99">Hampir Selesai (76-99%)</option>
                        <option value="100">Selesai (100%)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Dari Tanggal</label>
                    <input type="date" id="dateFromFilter" onchange="filterData()">
                </div>
                <div class="filter-group">
                    <label>Sampai Tanggal</label>
                    <input type="date" id="dateToFilter" onchange="filterData()">
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>

        <!-- Data Table -->
        <div class="data-container fade-in-up" style="animation-delay: 0.6s;">
            <div class="data-header">
                <div class="data-title">
                    <i class="fas fa-database"></i>
                    <span>Data Progress Kegiatan</span>
                    <span id="dataCount" style="color: #6b7280; font-size: 1rem; font-weight: 500;">(0 data)</span>
                </div>
                <div class="data-actions">
                    <button class="btn btn-info" onclick="window.location.href='executive-dashboard.html'">
                        <i class="fas fa-chart-pie"></i>
                        <span>Executive Dashboard</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" onclick="toggleExportDropdown()">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                            <i class="fas fa-chevron-down" style="margin-left: 8px; font-size: 0.8rem;"></i>
                    </button>
                        <div class="dropdown-menu" id="exportDropdown">
                            <button class="dropdown-item" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i>
                                Export CSV
                            </button>
                            <button class="dropdown-item" onclick="exportData('json')">
                                <i class="fas fa-file-code"></i>
                                Export JSON
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="refreshData()" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh Data</span>
                    </button>
                </div>
            </div>

            <div id="tableContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Kegiatan</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="editForm">
                <div class="form-group">
                    <label>Nama Kegiatan *</label>
                    <input type="text" id="edit_namaKegiatan" required>
                </div>
                
                <div class="form-group">
                    <label>Nama Paket</label>
                    <input type="text" id="edit_namaPaket">
                </div>
                
                <div class="form-group">
                    <label>Pagu Anggaran (Rp) *</label>
                    <input type="number" id="edit_paguAnggaran" required>
                </div>
                
                <div class="form-group">
                    <label>Nilai Kontrak (Rp) *</label>
                    <input type="number" id="edit_nilaiKontrak" required>
                    <small style="color: #666; font-size: 0.8rem;">Nilai kontrak harus ≤ Pagu Anggaran</small>
                </div>
                
                <div class="form-group">
                    <label>Progress Keuangan (Rp)</label>
                    <input type="number" id="edit_progressKeuangan">
                </div>
                
                <div class="form-group">
                    <label>Progress Fisik (%)</label>
                    <input type="number" id="edit_progressFisik" min="0" max="100">
                </div>
                
                <div class="form-group">
                    <label>Lokasi Kegiatan</label>
                    <input type="text" id="edit_lokasiKegiatan" placeholder="Lokasi pelaksanaan kegiatan">
                </div>
                
                <div class="form-group">
                    <label>PIC Program</label>
                    <select id="edit_picProgram">
                        <option value="">-- Pilih Unit Kerja Eselon 2 --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Uraian Output</label>
                    <textarea id="edit_uraianOutput"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Indikator</label>
                    <textarea id="edit_indikator"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Target Output</label>
                    <textarea id="edit_targetOutput"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Hambatan</label>
                    <textarea id="edit_hambatan"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Mitigasi</label>
                    <textarea id="edit_mitigasi"></textarea>
                </div>
            </form>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button type="button" class="btn btn-primary" onclick="saveEditData()">
                    <i class="fas fa-save"></i> Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- View Detail Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Detail Kegiatan</h3>
                <button class="close-btn" onclick="closeViewModal()">&times;</button>
            </div>
            
            <div class="view-content">
                <!-- Header Section -->
                <div class="view-section">
                    <div class="view-header">
                        <h4 id="view_namaKegiatan">-</h4>
                        <div class="view-badges">
                            <span class="badge" id="view_statusBadge">-</span>
                            <span class="badge secondary" id="view_satkerBadge">-</span>
                        </div>
                    </div>
                    <p class="view-subtitle" id="view_namaPaket">-</p>
                </div>

                <!-- Progress Section -->
                <div class="view-section">
                    <h5><i class="fas fa-chart-line"></i> Progress & Keuangan</h5>
                    <div class="progress-grid">
                        <div class="progress-card">
                            <div class="progress-label">Progress Fisik</div>
                            <div class="progress-value" id="view_progressFisik">0%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="view_progressFisikBar"></div>
                            </div>
                        </div>
                        <div class="progress-card">
                            <div class="progress-label">Penyerapan Keuangan</div>
                            <div class="progress-value" id="view_progressKeuangan">0%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="view_progressKeuanganBar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Section -->
                <div class="view-section">
                    <h5><i class="fas fa-money-bill-wave"></i> Informasi Keuangan</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Pagu Anggaran</div>
                            <div class="info-value" id="view_paguAnggaran">Rp 0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Nilai Kontrak</div>
                            <div class="info-value" id="view_nilaiKontrak">Rp 0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Realisasi</div>
                            <div class="info-value" id="view_realisasi">Rp 0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Sisa Anggaran</div>
                            <div class="info-value" id="view_sisaAnggaran">Rp 0</div>
                        </div>
                    </div>
                </div>

                <!-- Location & PIC Section -->
                <div class="view-section">
                    <h5><i class="fas fa-map-marker-alt"></i> Lokasi & Penanggung Jawab</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Lokasi Kegiatan</div>
                            <div class="info-value" id="view_lokasiKegiatan">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">PIC Program</div>
                            <div class="info-value" id="view_picProgram">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Provinsi</div>
                            <div class="info-value" id="view_provinsi">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Kabupaten/Kota</div>
                            <div class="info-value" id="view_kabupaten">-</div>
                        </div>
                    </div>
                </div>

                <!-- Output & Target Section -->
                <div class="view-section">
                    <h5><i class="fas fa-bullseye"></i> Output & Target</h5>
                    <div class="view-text-item">
                        <div class="info-label">Uraian Output</div>
                        <div class="info-text" id="view_uraianOutput">-</div>
                    </div>
                    <div class="view-text-item">
                        <div class="info-label">Indikator</div>
                        <div class="info-text" id="view_indikator">-</div>
                    </div>
                    <div class="view-text-item">
                        <div class="info-label">Target Output</div>
                        <div class="info-text" id="view_targetOutput">-</div>
                    </div>
                </div>

                <!-- Issues & Solutions Section -->
                <div class="view-section">
                    <h5><i class="fas fa-exclamation-triangle"></i> Hambatan & Mitigasi</h5>
                    <div class="view-text-item">
                        <div class="info-label">Hambatan</div>
                        <div class="info-text" id="view_hambatan">-</div>
                    </div>
                    <div class="view-text-item">
                        <div class="info-label">Mitigasi</div>
                        <div class="info-text" id="view_mitigasi">-</div>
                    </div>
                </div>

                <!-- Timeline Section -->
                <div class="view-section">
                    <h5><i class="fas fa-calendar-alt"></i> Timeline</h5>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Tanggal Mulai</div>
                            <div class="info-value" id="view_tanggalMulai">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Tanggal Selesai</div>
                            <div class="info-value" id="view_tanggalSelesai">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Dibuat</div>
                            <div class="info-value" id="view_createdAt">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Terakhir Update</div>
                            <div class="info-value" id="view_updatedAt">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeViewModal()">
                    <i class="fas fa-times"></i> Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="satker-data-complete.js"></script>
    <script src="unit-kerja-kementrans.js"></script>
    <script src="simple_auth.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions - SIMPLE VERSION
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBcetwoMXOnXuU60WSaUaUce-g1GVSDmWE",
            authDomain: "dashboard-kementrans.firebaseapp.com",
            projectId: "dashboard-kementrans",
            storageBucket: "dashboard-kementrans.firebasestorage.app",
            messagingSenderId: "852941680228",
            appId: "1:852941680228:web:57f9502b71e246ea8e7971",
            measurementId: "G-MRMNSD561Q"
        };

        // Initialize Firebase - SIMPLE VERSION
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally - SIMPLE VERSION LIKE TEST PAGE
        window.firebase = {
            app, db, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy
        };
        
        window.firebaseReady = true;
        console.log('🔥 Firebase initialized successfully - SIMPLE VERSION');
        
        // Auto-initialize after Firebase ready
        setTimeout(() => {
            initializeDashboard();
        }, 1000);
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let allProgressData = [];
        let filteredData = [];
        let currentEditId = null;

        // Initialize dashboard - SIMPLE VERSION
        async function initializeDashboard() {
            try {
                console.log('🚀 Initializing SIMPLE Progress Dashboard...');
                
                // ✅ Check for refresh parameter from form submission
                const urlParams = new URLSearchParams(window.location.search);
                const forceRefresh = urlParams.get('refresh') === 'true';
                
                if (forceRefresh) {
                    console.log('🔄 Force refresh requested from form submission');
                    // Clear localStorage to force Firebase reload
                    localStorage.removeItem('satker_progress_data');
                    // Remove refresh parameter from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // ✅ DEBUG: Check if already initialized to prevent double calls
                if (window.dashboardInitialized && !forceRefresh) {
                    console.warn('⚠️ Dashboard already initialized, skipping...');
                    return;
                }
                window.dashboardInitialized = true;
                
                // Check authentication
                if (!checkAuth()) {
                    showLoginPrompt();
                        return;
                    }
                    
                // Update user display
                updateUserDisplay();
                
                // Load data - SIMPLE VERSION
                await loadProgressData();
                
                // Setup search
                setupSearch();
                
                console.log('✅ Dashboard initialized successfully - NO AUTO-REFRESH');
                showMessage('Dashboard berhasil dimuat', 'success');
                
            } catch (error) {
                console.error('❌ Dashboard initialization error:', error);
                showMessage('Error loading dashboard: ' + error.message, 'error');
            }
        }

        // Check authentication
        function checkAuth() {
            try {
                if (window.SimpleAuth) {
                    currentUser = window.SimpleAuth.getCurrentUser();
                } else {
                    // Fallback to localStorage
                    const userStr = localStorage.getItem('satker_current_user');
                    if (userStr) {
                        currentUser = JSON.parse(userStr);
                    }
                }
                
                if (currentUser) {
                    console.log('✅ User authenticated:', currentUser.username);
                    return true;
                } else {
                    console.log('❌ No authenticated user found');
                    return false;
                }
                } catch (error) {
                console.error('❌ Auth check error:', error);
                return false;
            }
        }

        // Update user display
        function updateUserDisplay() {
            if (!currentUser) return;
            
            const displayName = currentUser.fullName || currentUser.username || 'Unknown User';
            const satkerDisplay = currentUser.satkerName || currentUser.satkerCode || 'Unknown Satker';
            
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userSatker').textContent = satkerDisplay;
        }

        // Logout function
        function logout() {
            if (confirm('🚪 Apakah Anda yakin ingin logout dari sistem?')) {
                try {
                    // Use SimpleAuth logout
                    window.SimpleAuth.logout();
                    
                    // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        z-index: 10000;
                        font-weight: 600;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                    `;
                    notification.innerHTML = '✅ Logout berhasil!';
                document.body.appendChild(notification);
                
                    // Redirect to login
                setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                    
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('❌ Logout gagal. Silakan coba lagi.');
                }
            }
        }

        // Load progress data - SIMPLE VERSION
        async function loadProgressData() {
            try {
                console.log('📊 Loading progress data - SIMPLE VERSION...');
                showMessage('Loading data from Firebase...', 'info');
                
                allProgressData = [];
                
                // Load from Firebase - SIMPLE VERSION
                if (window.firebaseReady && window.firebase) {
                    await loadFromFirebase();
            } else {
                    // Fallback to localStorage
                    loadFromLocalStorage();
                }
                
                // Update display
                filteredData = [...allProgressData];
                updateStatistics();
                displayData();
                
                console.log(`✅ Loaded ${allProgressData.length} progress records`);
                
                if (allProgressData.length > 0) {
                    showMessage(`Data berhasil dimuat: ${allProgressData.length} records`, 'success');
            } else {
                    showMessage('Belum ada data. Silakan tambah data kegiatan.', 'info');
                }
                
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showMessage('Error loading data: ' + error.message, 'error');
                
                // Fallback to localStorage
                loadFromLocalStorage();
                updateStatistics();
                displayData();
            }
        }

        // Load from Firebase - SIMPLE VERSION
        async function loadFromFirebase() {
            try {
                console.log('🔥 Loading from Firebase - SIMPLE VERSION...');
                
                let progressQuery;
                
                if (currentUser.role === 'super_admin') {
                    // Super admin sees all data
                    progressQuery = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'progress_data'),
                        window.firebase.orderBy('updatedAt', 'desc')
                    );
                } else {
                    // Regular user sees only their satker data
                    progressQuery = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'progress_data'),
                        window.firebase.where('viewableBy', 'array-contains', currentUser.satkerCode)
                    );
                }
                
                const snapshot = await window.firebase.getDocs(progressQuery);
                        
                allProgressData = [];
                snapshot.forEach((doc) => {
                            const data = doc.data();
                    data.firebaseId = doc.id;
                            allProgressData.push(data);
                        });
                        
                // ✅ REMOVE DUPLICATES
                const originalCount = allProgressData.length;
                allProgressData = removeDuplicates(allProgressData);
                if (originalCount > allProgressData.length) {
                    console.log(`🧹 Removed ${originalCount - allProgressData.length} duplicate records`);
                }
                
                // Sort by updated date
                        allProgressData.sort((a, b) => {
                    const dateA = new Date(a.updatedAt || a.createdAt || 0);
                    const dateB = new Date(b.updatedAt || b.createdAt || 0);
                    return dateB - dateA;
                });
                
                // Save to localStorage as backup
                localStorage.setItem('satker_progress_data', JSON.stringify(allProgressData));
                
                console.log(`✅ Loaded ${allProgressData.length} records from Firebase`);
                
            } catch (error) {
                console.error('❌ Firebase load error:', error);
                throw error;
            }
        }

        // Remove duplicates based on unique combination of key fields
        function removeDuplicates(data) {
            const seen = new Map();
            const unique = [];
            const duplicates = [];
            
            for (const item of data) {
                // Create unique key based on critical fields
                const key = `${item.satkerCode || ''}_${item.namaKegiatan || ''}_${item.kodeKegiatan || ''}_${item.targetOutput || ''}`;
                
                if (!seen.has(key)) {
                    seen.set(key, item);
                    unique.push(item);
                        } else {
                    const original = seen.get(key);
                    duplicates.push({
                        duplicate: item,
                        original: original,
                        key: key
                    });
                    console.log(`🗑️ Removing duplicate: ${item.namaKegiatan} (${item.satkerCode})`);
                }
            }
            
            // ✅ Show duplicate summary if found
            if (duplicates.length > 0) {
                console.group('🔍 DUPLICATE DATA DETECTED');
                console.log(`Found ${duplicates.length} duplicate entries:`);
                duplicates.forEach((dup, index) => {
                    console.log(`${index + 1}. "${dup.duplicate.namaKegiatan}" - ${dup.duplicate.satkerCode}`);
                    console.log(`   Original created: ${dup.original.createdAt || 'Unknown'}`);
                    console.log(`   Duplicate created: ${dup.duplicate.createdAt || 'Unknown'}`);
                });
                console.groupEnd();
                
                // Show user-friendly message
                if (duplicates.length > 0) {
                    setTimeout(() => {
                        showMessage(`🧹 Ditemukan ${duplicates.length} data duplikat yang sudah dihapus otomatis`, 'warning');
                    }, 2000);
                }
            }
            
            return unique;
        }

        // Load from localStorage fallback
        function loadFromLocalStorage() {
            try {
                console.log('📱 Loading from localStorage...');
                
                const stored = localStorage.getItem('satker_progress_data') || '[]';
                allProgressData = JSON.parse(stored);
                
                // ✅ REMOVE DUPLICATES from localStorage too
                const originalCount = allProgressData.length;
                allProgressData = removeDuplicates(allProgressData);
                if (originalCount > allProgressData.length) {
                    console.log(`🧹 Removed ${originalCount - allProgressData.length} duplicate records from localStorage`);
                    // Save cleaned data back to localStorage
                    localStorage.setItem('satker_progress_data', JSON.stringify(allProgressData));
                }
                
                // Filter based on user role
                if (currentUser.role !== 'super_admin') {
                    allProgressData = allProgressData.filter(item => 
                        item.satkerCode === currentUser.satkerCode ||
                        (item.viewableBy && item.viewableBy.includes(currentUser.satkerCode))
                    );
                }
                
                console.log(`✅ Loaded ${allProgressData.length} records from localStorage`);
                
            } catch (error) {
                console.error('❌ localStorage load error:', error);
                allProgressData = [];
            }
        }

        // Update statistics - SEPARATE TRACKING (NO MISLEADING DATA)
        function updateStatistics() {
            const totalKegiatan = filteredData.length;
            
            // ✅ IMPROVED: Validate and clean numeric data
            const validData = filteredData.filter(item => item && typeof item === 'object');
            
            // 🎯 SEPARATE TRACKING: Kegiatan berdasarkan status kontrak
            const kegiatanSudahKontrak = validData.filter(item => {
                const nilaiKontrak = parseFloat(item.nilaiKontrak) || 0;
                return nilaiKontrak > 0;
            });
            
            const kegiatanBelumKontrak = validData.filter(item => {
                const nilaiKontrak = parseFloat(item.nilaiKontrak) || 0;
                return nilaiKontrak === 0;
            });
            
            // 💰 CALCULATE TOTALS
            const totalAnggaran = validData.reduce((sum, item) => {
                // Smart getter untuk handle old/new field names
                const value = parseFloat(item.paguAnggaran || item.nilaiAnggaran) || 0;
                return sum + value;
            }, 0);
            
            // ✅ FAKTUAL: Total Kontrak HANYA dari yang benar-benar ada kontrak
            const totalKontrak = kegiatanSudahKontrak.reduce((sum, item) => {
                const value = parseFloat(item.nilaiKontrak) || 0;
                return sum + value;
            }, 0);
            
            const totalRealisasi = validData.reduce((sum, item) => {
                const value = parseFloat(item.progressKeuangan) || 0;
                return sum + value;
            }, 0);
            
            // 🎯 SMART PROGRESS CALCULATION - NO MISLEADING DATA
            let avgProgress = 0;
            let progressMethod = '';
            let progressStatus = '';
            
            if (totalKontrak > 0) {
                // Ada kontrak → hitung dari nilai kontrak
                avgProgress = (totalRealisasi / totalKontrak) * 100;
                progressMethod = 'Dari nilai kontrak';
                progressStatus = `${kegiatanSudahKontrak.length}/${totalKegiatan} berkontrak`;
                
                console.log('🎯 CALCULATING PROGRESS (SEPARATE TRACKING):');
                console.log(`📋 Method: Progress dari nilai kontrak`);
                console.log(`📊 Kegiatan Sudah Kontrak: ${kegiatanSudahKontrak.length}`);
                console.log(`📊 Kegiatan Belum Kontrak: ${kegiatanBelumKontrak.length}`);
                console.log(`💰 Total Realisasi: ${formatCurrency(totalRealisasi)}`);
                console.log(`📄 Total Nilai Kontrak: ${formatCurrency(totalKontrak)} (FAKTUAL)`);
                console.log(`🧮 Calculation: (${totalRealisasi.toLocaleString()} ÷ ${totalKontrak.toLocaleString()}) × 100%`);
                console.log(`✅ Progress Rate: ${Math.round(avgProgress)}%`);
                
            } else if (totalAnggaran > 0) {
                // Belum ada kontrak → hitung dari pagu anggaran dengan warning
                avgProgress = (totalRealisasi / totalAnggaran) * 100;
                progressMethod = 'Dari pagu anggaran';
                progressStatus = 'Belum ada kontrak';
                
                console.log('⚠️ FALLBACK CALCULATION (NO CONTRACT YET):');
                console.log(`📋 Method: Progress dari pagu anggaran (fallback)`);
                console.log(`⚠️ Warning: Semua kegiatan belum ada kontrak`);
                console.log(`💰 Total Realisasi: ${formatCurrency(totalRealisasi)}`);
                console.log(`💰 Total Pagu Anggaran: ${formatCurrency(totalAnggaran)}`);
                console.log(`🧮 Calculation: (${totalRealisasi.toLocaleString()} ÷ ${totalAnggaran.toLocaleString()}) × 100%`);
                console.log(`⚠️ Progress Rate: ${Math.round(avgProgress)}% (estimasi)`);
                
                } else {
                console.log('❌ Cannot calculate progress: No contract and no budget data');
                progressMethod = 'Tidak dapat dihitung';
                progressStatus = 'Data tidak lengkap';
            }
            
            // ✅ SUMMARY: Enhanced logging with breakdown
            console.log('📊 Statistics Summary (SEPARATE TRACKING):', {
                totalKegiatan,
                kegiatanSudahKontrak: kegiatanSudahKontrak.length,
                kegiatanBelumKontrak: kegiatanBelumKontrak.length,
                kontrakRate: `${((kegiatanSudahKontrak.length / totalKegiatan) * 100).toFixed(1)}%`,
                progressRate: avgProgress.toFixed(2) + '%',
                progressMethod,
                totalAnggaran: formatCurrency(totalAnggaran),
                totalKontrak: formatCurrency(totalKontrak) + ' (FAKTUAL)',
                totalRealisasi: formatCurrency(totalRealisasi)
            });
            
            // 📊 UPDATE UI - ENHANCED WITH BREAKDOWN
            document.getElementById('totalKegiatan').textContent = totalKegiatan;
            document.getElementById('kegiatanSudahKontrak').textContent = kegiatanSudahKontrak.length;
            document.getElementById('kegiatanBelumKontrak').textContent = kegiatanBelumKontrak.length;
            
            document.getElementById('avgProgress').textContent = Math.round(avgProgress) + '%';
            document.getElementById('progressMethod').textContent = progressMethod;
            
            document.getElementById('totalAnggaran').textContent = formatCurrency(totalAnggaran);
            document.getElementById('totalKontrak').textContent = formatCurrency(totalKontrak);
            document.getElementById('kontrakStatus').textContent = progressStatus;
            
            document.getElementById('totalRealisasi').textContent = formatCurrency(totalRealisasi);
            document.getElementById('dataCount').textContent = `(${totalKegiatan} data)`;
            
            // 🎨 VISUAL INDICATORS
            const avgProgressElement = document.getElementById('avgProgress');
            const progressMethodElement = document.getElementById('progressMethod');
            
            if (totalKontrak > 0) {
                avgProgressElement.style.color = '#10b981'; // Green for factual data
                progressMethodElement.style.color = '#10b981';
            } else {
                avgProgressElement.style.color = '#f59e0b'; // Orange for fallback
                progressMethodElement.style.color = '#f59e0b';
            }
        }

        // Display data in table
        function displayData() {
            const tableContent = document.getElementById('tableContent');
            
            if (filteredData.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                        <h3>Belum ada data</h3>
                        <p>Silakan tambah data kegiatan untuk mulai monitoring progress.</p>
                        <a href="form-progress-kegiatan.html" class="btn btn-primary" style="margin-top: 20px; display: inline-block; text-decoration: none;">
                            <i class="fas fa-plus"></i> Tambah Data Progress</a>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama Kegiatan</th>
                                <th>Lokasi</th>
                                <th>PIC Program</th>
                                <th>Pagu Anggaran</th>
                                <th>Nilai Kontrak</th>
                                <th>Progress Keuangan</th>
                                <th>Progress Fisik</th>
                                <th>Target Output</th>
                            <th>Last Update</th>
                            <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredData.forEach((item, index) => {
                // Smart getter untuk progress fisik (handle old/new formats)
                const progressPercentage = getProgressFisik(item);
                const progressStatus = getProgressFisikStatus(progressPercentage);
                
                // Smart getter untuk handle old/new field names
                const paguAnggaran = item.paguAnggaran || item.nilaiAnggaran || 0;
                const nilaiKontrak = item.nilaiKontrak || 0;
                
                // Smart getter untuk PIC Program
                const picProgram = getPICProgramInfo(item.picProgram);
                
                // CORRECTED: Persentase penyerapan dihitung dari nilai kontrak, bukan pagu anggaran
                // Fallback: Jika data lama belum ada nilaiKontrak, pakai paguAnggaran
                const denominator = nilaiKontrak > 0 ? nilaiKontrak : paguAnggaran;
                const progressKeuanganPct = denominator > 0 ? 
                    Math.round((item.progressKeuangan || 0) / denominator * 100) : 0;
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <strong>${item.namaKegiatan || 'Tidak ada nama'}</strong>
                            <br><small style="color: #6b7280;">${item.satkerName || 'Unknown Satker'}</small>
                    </td>
                    <td>
                            <i class="fas fa-map-marker-alt" style="color: #6b7280; margin-right: 5px;"></i>
                            ${item.lokasiKegiatan || '-'}
                    </td>
                        <td>
                            <i class="fas fa-user-tie" style="color: #6b7280; margin-right: 5px;"></i>
                            ${picProgram.nama || '-'}
                            ${picProgram.singkatan ? `<br><small style="color: #6b7280;">${picProgram.singkatan}</small>` : ''}
                    </td>
                        <td>${formatCurrency(paguAnggaran)}</td>
                        <td>${formatCurrency(nilaiKontrak)}</td>
                        <td>
                            <div>${formatCurrency(item.progressKeuangan || 0)}</div>
                            <div class="progress-bar" style="margin-top: 4px;">
                                <div class="progress-fill" style="width: ${progressKeuanganPct}%"></div>
                        </div>
                            <small style="color: #6b7280;">${progressKeuanganPct}%</small>
                    </td>
                    <td>
                        <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <small style="color: #6b7280;">${progressPercentage}% - ${progressStatus}</small>
                    </td>
                        <td>${item.targetOutput || '-'}</td>
                    <td>
                            <small style="color: #6b7280;">
                                ${item.updatedAt ? new Date(item.updatedAt).toLocaleDateString('id-ID') : 
                                  item.createdAt ? new Date(item.createdAt).toLocaleDateString('id-ID') : '-'}
                            </small>
                    </td>
                    <td>
                            <div class="actions">
                            <button class="action-btn view" onclick="viewData('${item.id}')" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editData('${item.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteData('${item.id}')" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            });
            
            html += '</tbody></table>';
            tableContent.innerHTML = html;
        }

        // Edit data
        function editData(itemId) {
            console.log('📝 Starting edit for:', itemId);
            
            const item = allProgressData.find(d => d.id === itemId);
                if (!item) {
                showMessage('Data tidak ditemukan', 'error');
                    return;
                }
                
            // Populate form with smart getters - COMPLETE FIELDS
            document.getElementById('edit_namaKegiatan').value = item.namaKegiatan || '';
            document.getElementById('edit_namaPaket').value = item.namaPaket || '';
            
            // Smart getter untuk handle old/new field names
            document.getElementById('edit_paguAnggaran').value = getPaguAnggaran(item);
            document.getElementById('edit_nilaiKontrak').value = item.nilaiKontrak || '';
            document.getElementById('edit_progressKeuangan').value = item.progressKeuangan || '';
            document.getElementById('edit_progressFisik').value = getProgressFisik(item);
            
            // Activity details
            document.getElementById('edit_uraianOutput').value = item.uraianOutput || '';
            document.getElementById('edit_indikator').value = item.indikator || '';
            document.getElementById('edit_targetOutput').value = item.targetOutput || '';
            document.getElementById('edit_lokasiKegiatan').value = item.lokasiKegiatan || '';
            
            // Issues & solutions
            document.getElementById('edit_hambatan').value = item.hambatan || item.kendalaHambatan || item.kendala || '';
            document.getElementById('edit_mitigasi').value = item.mitigasi || '';
            
            // Populate PIC Program dropdown
            try {
                if (typeof window.UnitKerjaKementrans !== 'undefined') {
                    window.UnitKerjaKementrans.populatePICProgramDropdown('edit_picProgram');
                    // Set selected value
                    setTimeout(() => {
                        document.getElementById('edit_picProgram').value = item.picProgram || '';
                    }, 100);
                } else {
                    console.warn('⚠️ UnitKerjaKementrans not available for edit modal');
                }
            } catch (error) {
                console.error('❌ Error populating PIC Program in edit modal:', error);
            }
            
            console.log('📝 Edit form populated with data:', {
                namaKegiatan: item.namaKegiatan,
                namaPaket: item.namaPaket,
                paguAnggaran: getPaguAnggaran(item),
                nilaiKontrak: item.nilaiKontrak,
                lokasiKegiatan: item.lokasiKegiatan,
                picProgram: item.picProgram,
                progressFisik: getProgressFisik(item)
            });
            
            currentEditId = itemId;
            
            // Show modal
            document.getElementById('editModal').style.display = 'block';
            
            showMessage(`Editing: ${item.namaKegiatan}`, 'info');
        }

        // Save edited data - SIMPLE & WORKING VERSION
        async function saveEditData() {
            try {
                if (!currentEditId) {
                    showMessage('No item selected for editing', 'error');
                    return;
                }
                
                console.log('💾 Starting SIMPLE save for:', currentEditId);
                
                // Get form data
                const namaKegiatan = document.getElementById('edit_namaKegiatan').value.trim();
                const paguAnggaran = parseFloat(document.getElementById('edit_paguAnggaran').value) || 0;
                const nilaiKontrak = parseFloat(document.getElementById('edit_nilaiKontrak').value) || 0;
                
                if (!namaKegiatan || !paguAnggaran) {
                    showMessage('Nama Kegiatan dan Pagu Anggaran wajib diisi', 'error');
                        return;
                }
                
                // Validate nilai kontrak <= pagu anggaran
                if (nilaiKontrak > 0 && nilaiKontrak > paguAnggaran) {
                    showMessage('Nilai kontrak tidak boleh lebih besar dari Pagu Anggaran!', 'error');
                    return;
                }
                
                // Validate progress fisik
                const progressFisik = parseFloat(document.getElementById('edit_progressFisik').value) || 0;
                if (progressFisik < 0 || progressFisik > 100) {
                    showMessage('Progress fisik harus antara 0% dan 100%!', 'error');
                    return;
                }
                
                const updatedData = {
                    // Basic info
                    namaKegiatan: namaKegiatan,
                    namaPaket: document.getElementById('edit_namaPaket').value.trim() || '',
                    
                    // Financial data - Dual write untuk compatibility
                    nilaiAnggaran: paguAnggaran, // Old field name (compatibility)
                    paguAnggaran: paguAnggaran,  // New field name
                    nilaiKontrak: nilaiKontrak,  // New field
                    progressKeuangan: parseFloat(document.getElementById('edit_progressKeuangan').value) || 0,
                    progressFisik: parseFloat(document.getElementById('edit_progressFisik').value) || 0, // Changed to parseFloat for number input
                    
                    // Activity details
                    uraianOutput: document.getElementById('edit_uraianOutput').value.trim() || '',
                    indikator: document.getElementById('edit_indikator').value.trim() || '',
                    targetOutput: document.getElementById('edit_targetOutput').value.trim() || '',
                    lokasiKegiatan: document.getElementById('edit_lokasiKegiatan').value.trim() || '',
                    picProgram: document.getElementById('edit_picProgram').value.trim() || '', // NEW FIELD
                    
                    // Issues & solutions
                    hambatan: document.getElementById('edit_hambatan').value.trim() || '',
                    mitigasi: document.getElementById('edit_mitigasi').value.trim() || '',
                    
                    // Metadata
                    updatedAt: new Date().toISOString(),
                    lastEditedBy: currentUser?.username || 'unknown'
                };
                
                console.log('📝 Data to save (COMPLETE):', {
                    namaKegiatan: updatedData.namaKegiatan,
                    namaPaket: updatedData.namaPaket,
                    paguAnggaran: updatedData.paguAnggaran,
                    nilaiKontrak: updatedData.nilaiKontrak,
                    lokasiKegiatan: updatedData.lokasiKegiatan,
                    picProgram: updatedData.picProgram,
                    progressFisik: updatedData.progressFisik,
                    hambatan: updatedData.hambatan,
                    mitigasi: updatedData.mitigasi
                });
                
                // Find item in local array
                const itemIndex = allProgressData.findIndex(d => d.id === currentEditId);
                if (itemIndex === -1) {
                    throw new Error('Item not found in local data');
                }

                // Update local data IMMEDIATELY
                allProgressData[itemIndex] = { ...allProgressData[itemIndex], ...updatedData };

                // Save to localStorage IMMEDIATELY
                localStorage.setItem('satker_progress_data', JSON.stringify(allProgressData));
                console.log('✅ Saved to localStorage');
                
                // Update UI IMMEDIATELY
                filteredData = [...allProgressData];
                updateStatistics();
                displayData();
                
                // Close modal IMMEDIATELY
                closeEditModal();
                
                // Save to Firebase in background
                let firebaseSuccess = false;
                if (window.firebaseReady && window.firebase) {
                    try {
                        const firebaseItem = allProgressData[itemIndex];
                        
                        if (firebaseItem.firebaseId) {
                            // Update existing
                            console.log('📝 Updating Firebase doc:', firebaseItem.firebaseId);
                            const docRef = window.firebase.doc(window.firebase.db, 'progress_data', firebaseItem.firebaseId);
                            await window.firebase.updateDoc(docRef, updatedData);
                            firebaseSuccess = true;
                            console.log('✅ Firebase update successful');
                        } else {
                            // Create new
                            console.log('🆕 Creating new Firebase doc');
                            const docRef = await window.firebase.addDoc(
                                window.firebase.collection(window.firebase.db, 'progress_data'),
                                { ...firebaseItem, ...updatedData }
                            );
                            allProgressData[itemIndex].firebaseId = docRef.id;
                            localStorage.setItem('satker_progress_data', JSON.stringify(allProgressData));
                            firebaseSuccess = true;
                            console.log('✅ Firebase create successful:', docRef.id);
                        }
                    } catch (firebaseError) {
                        console.error('❌ Firebase save error:', firebaseError);
                        showMessage('⚠️ Data disimpan lokal (Firebase error): ' + firebaseError.message, 'warning');
                    }
                }
                
                // Show success message
                if (firebaseSuccess) {
                    showMessage('✅ Data berhasil disimpan ke Firebase!', 'success');
                } else {
                    showMessage('✅ Data disimpan lokal (akan sync ke Firebase saat online)', 'warning');
                }
                
                // NO AUTO-REFRESH - Data already updated!
                console.log('✅ Edit completed successfully - data persisted');

            } catch (error) {
                console.error('❌ Save error:', error);
                showMessage('❌ Error saving: ' + error.message, 'error');
            }
        }

        // Delete data
        async function deleteData(itemId) {
            if (!confirm('Yakin ingin menghapus data ini?')) {
                    return;
                }

            try {
                console.log('🗑️ Deleting item:', itemId);
                
                const item = allProgressData.find(d => d.id === itemId);
                if (!item) {
                    throw new Error('Item not found');
                }
                
                // Delete from Firebase
                if (window.firebaseReady && window.firebase && item.firebaseId) {
                    try {
                        await window.firebase.deleteDoc(
                            window.firebase.doc(window.firebase.db, 'progress_data', item.firebaseId)
                        );
                        console.log('✅ Deleted from Firebase');
                    } catch (firebaseError) {
                        console.error('❌ Firebase delete error:', firebaseError);
                    }
                }
                
                // Remove from local data
                allProgressData = allProgressData.filter(d => d.id !== itemId);
                localStorage.setItem('satker_progress_data', JSON.stringify(allProgressData));
                
                // Update UI
                filteredData = [...allProgressData];
                updateStatistics();
                displayData();

                showMessage('✅ Data berhasil dihapus', 'success');

            } catch (error) {
                console.error('❌ Delete error:', error);
                showMessage('❌ Error deleting: ' + error.message, 'error');
            }
        }

        // SIMPLE REFRESH - Like progress-dashboard-new.html
        async function refreshData() {
            console.log('🔄 Manual refresh requested - SIMPLE VERSION');
            
            const refreshBtn = document.querySelector('.btn-primary');
            const originalHTML = refreshBtn?.innerHTML;
            
            // Show loading state
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                refreshBtn.disabled = true;
            }
            
            try {
                showMessage('Refreshing data...', 'info');
                await loadProgressData();
            } catch (error) {
                console.error('❌ Refresh error:', error);
                showMessage('❌ Refresh failed: ' + error.message, 'error');
            } finally {
                // Restore button
                if (refreshBtn && originalHTML) {
                    refreshBtn.innerHTML = originalHTML;
                    refreshBtn.disabled = false;
                }
            }
        }

        // Add new data
        function addNewData() {
            window.location.href = 'form-progress-kegiatan.html';
        }

        // Toggle export dropdown
        function toggleExportDropdown() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.dropdown')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        // Export data with format selection
        function exportData(format = 'json') {
            try {
                const currentDate = new Date().toISOString().split('T')[0];
                const exportMetadata = {
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser?.username || 'unknown',
                    totalRecords: filteredData.length,
                    format: format.toUpperCase()
                };

                let blob, fileName, mimeType;

                if (format === 'csv') {
                    // Generate CSV
                    const csvContent = generateCSV(filteredData, exportMetadata);
                    blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    fileName = `progress_data_${currentDate}.csv`;
                    mimeType = 'CSV';
                } else {
                    // Generate JSON (default)
                    const dataToExport = {
                        ...exportMetadata,
                        data: filteredData
                    };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                    blob = new Blob([jsonString], { type: 'application/json' });
                    fileName = `progress_data_${currentDate}.json`;
                    mimeType = 'JSON';
                }
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Close dropdown
                document.getElementById('exportDropdown').classList.remove('show');
                
                showMessage(`✅ Data berhasil diekspor dalam format ${mimeType}`, 'success');
                console.log(`📥 Export successful: ${fileName} (${filteredData.length} records)`);
                
            } catch (error) {
                console.error('❌ Export error:', error);
                showMessage('❌ Export gagal: ' + error.message, 'error');
            }
        }

        // Generate CSV content
        function generateCSV(data, metadata) {
            if (!data || data.length === 0) {
                return `# Export Metadata\n# Export Date: ${metadata.exportDate}\n# Exported By: ${metadata.exportedBy}\n# Total Records: 0\n# Format: CSV\n\n# No data available`;
            }

            // CSV Header with metadata
            let csv = `# Export Metadata\n`;
            csv += `# Export Date: ${metadata.exportDate}\n`;
            csv += `# Exported By: ${metadata.exportedBy}\n`;
            csv += `# Total Records: ${metadata.totalRecords}\n`;
            csv += `# Format: CSV\n\n`;

            // Define CSV columns
            const columns = [
                'namaKegiatan',
                'namaPaket', 
                'satker',
                'provinsi',
                'kabupaten',
                'paguAnggaran',
                'nilaiKontrak',
                'progressKeuangan',
                'progressFisik',
                'lokasiKegiatan',
                'picProgram',
                'uraianOutput',
                'indikator',
                'targetOutput',
                'hambatan',
                'mitigasi',
                'tanggalMulai',
                'tanggalSelesai'
            ];

            // CSV Headers
            const headers = [
                'Nama Kegiatan',
                'Nama Paket',
                'Satuan Kerja',
                'Provinsi',
                'Kabupaten/Kota',
                'Pagu Anggaran (Rp)',
                'Nilai Kontrak (Rp)',
                'Progress Keuangan (Rp)',
                'Progress Fisik (%)',
                'Lokasi Kegiatan',
                'PIC Program',
                'Uraian Output',
                'Indikator',
                'Target Output',
                'Hambatan',
                'Mitigasi',
                'Tanggal Mulai',
                'Tanggal Selesai'
            ];

            csv += headers.join(',') + '\n';

            // CSV Data rows
            data.forEach(row => {
                const csvRow = columns.map(col => {
                    let value = row[col] || '';
                    
                    // Handle special formatting
                    if (col === 'paguAnggaran' || col === 'nilaiKontrak' || col === 'progressKeuangan') {
                        value = parseFloat(value) || 0;
                    } else if (col === 'progressFisik') {
                        value = parseFloat(value) || 0;
                    } else {
                        // Escape quotes and wrap in quotes if contains comma
                        value = String(value).replace(/"/g, '""');
                        if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                            value = `"${value}"`;
                        }
                    }
                    
                    return value;
                }).join(',');
                
                csv += csvRow + '\n';
            });

            return csv;
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditId = null;
        }

        // View data details
        function viewData(itemId) {
            console.log('👁️ Starting view for:', itemId);
            
            const item = allProgressData.find(d => d.id === itemId);
            if (!item) {
                showMessage('Data tidak ditemukan', 'error');
                return;
            }

            // View mode - read only

            // Smart getters for backward compatibility
            const paguAnggaran = getPaguAnggaran(item);
            const nilaiKontrak = parseFloat(item.nilaiKontrak) || 0;
            const progressKeuangan = parseFloat(item.progressKeuangan) || 0;
            const progressFisik = getProgressFisik(item);
            const picProgram = getPICProgramInfo(item.picProgram);

            // Calculate additional metrics
            const sisaAnggaran = paguAnggaran - progressKeuangan;
            const progressKeuanganPct = nilaiKontrak > 0 ? (progressKeuangan / nilaiKontrak) * 100 : 0;
            const progressStatus = getProgressFisikStatus(progressFisik);

            // Header Section
            document.getElementById('view_namaKegiatan').textContent = item.namaKegiatan || 'Tidak ada nama';
            document.getElementById('view_namaPaket').textContent = item.namaPaket || '-';
            
            // Status badges
            const statusBadge = document.getElementById('view_statusBadge');
            statusBadge.textContent = progressStatus;
            statusBadge.className = `badge ${progressFisik >= 75 ? '' : progressFisik >= 25 ? 'secondary' : 'secondary'}`;
            
            const satkerBadge = document.getElementById('view_satkerBadge');
            satkerBadge.textContent = item.satkerName || 'Unknown Satker';

            // Progress Section
            document.getElementById('view_progressFisik').textContent = `${progressFisik}%`;
            document.getElementById('view_progressFisikBar').style.width = `${progressFisik}%`;
            
            document.getElementById('view_progressKeuangan').textContent = `${progressKeuanganPct.toFixed(1)}%`;
            document.getElementById('view_progressKeuanganBar').style.width = `${progressKeuanganPct}%`;

            // Financial Section
            document.getElementById('view_paguAnggaran').textContent = formatCurrency(paguAnggaran);
            document.getElementById('view_nilaiKontrak').textContent = formatCurrency(nilaiKontrak);
            document.getElementById('view_realisasi').textContent = formatCurrency(progressKeuangan);
            document.getElementById('view_sisaAnggaran').textContent = formatCurrency(sisaAnggaran);

            // Location & PIC Section
            document.getElementById('view_lokasiKegiatan').textContent = item.lokasiKegiatan || '-';
            document.getElementById('view_picProgram').textContent = picProgram.nama || '-';
            document.getElementById('view_provinsi').textContent = item.provinsi || '-';
            document.getElementById('view_kabupaten').textContent = item.kabupaten || '-';

            // Output & Target Section
            document.getElementById('view_uraianOutput').textContent = item.uraianOutput || '-';
            document.getElementById('view_indikator').textContent = item.indikator || '-';
            document.getElementById('view_targetOutput').textContent = item.targetOutput || '-';

            // Issues & Solutions Section
            document.getElementById('view_hambatan').textContent = item.hambatan || '-';
            document.getElementById('view_mitigasi').textContent = item.mitigasi || '-';

            // Timeline Section
            const formatDate = (dateString) => {
                if (!dateString) return '-';
                try {
                    return new Date(dateString).toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch {
                    return dateString;
                }
            };

            document.getElementById('view_tanggalMulai').textContent = formatDate(item.tanggalMulai);
            document.getElementById('view_tanggalSelesai').textContent = formatDate(item.tanggalSelesai);
            document.getElementById('view_createdAt').textContent = formatDate(item.createdAt);
            document.getElementById('view_updatedAt').textContent = formatDate(item.updatedAt);

            // Show modal
            document.getElementById('viewModal').style.display = 'block';
            
            console.log('👁️ View modal opened for:', item.namaKegiatan);
        }

        // Close view modal
        function closeViewModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        // Filter data function
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const progressFilter = document.getElementById('progressFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;
            
            filteredData = allProgressData.filter(item => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    (item.namaKegiatan || '').toLowerCase().includes(searchTerm) ||
                    (item.kodeKegiatan || '').toLowerCase().includes(searchTerm) ||
                    (item.targetOutput || '').toLowerCase().includes(searchTerm);
                
                // Progress filter (using smart getter)
                let matchesProgress = true;
                if (progressFilter) {
                    const progress = getProgressFisik(item);
                    if (progressFilter === '0') {
                        matchesProgress = progress === 0;
                    } else if (progressFilter === '100') {
                        matchesProgress = progress === 100;
                    } else if (progressFilter.includes('-')) {
                        const [min, max] = progressFilter.split('-').map(Number);
                        matchesProgress = progress >= min && progress <= max;
                    }
                }
                
                // Date filter
                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const itemDate = new Date(item.updatedAt || item.createdAt || 0);
                    if (dateFrom) {
                        matchesDate = matchesDate && itemDate >= new Date(dateFrom);
                    }
                    if (dateTo) {
                        matchesDate = matchesDate && itemDate <= new Date(dateTo);
                    }
                }
                
                return matchesSearch && matchesProgress && matchesDate;
            });
            
            updateStatistics();
            displayData();
        }

        // Setup search
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', filterData);
        }

        // Show login prompt
        function showLoginPrompt() {
            document.getElementById('tableContent').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-lock"></i>
                    <h3>Login Required</h3>
                    <p>Silakan login untuk mengakses dashboard.</p>
                    <button class="btn btn-primary" onclick="window.location.href='login.html'" style="margin-top: 20px;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            `;
        }

        // Show message
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = message;
            
            container.appendChild(messageDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // ===== SMART GETTER FUNCTIONS FOR FIREBASE SYNC =====
        
        // Smart getter untuk Progress Fisik (handle old/new formats)
        function getProgressFisik(item) {
            if (typeof item.progressFisik === 'number') {
                return item.progressFisik; // New format: exact number
            } else if (typeof item.progressFisik === 'string') {
                // Old format: convert range to middle value
                const rangeMap = {
                    "0": 0, "1-25": 12.5, "26-50": 37.5, 
                    "51-75": 62.5, "76-85": 80, "86-95": 90, "96-100": 98
                };
                return rangeMap[item.progressFisik] || 0;
            }
            return 0;
        }
        
        // Smart getter untuk Progress Fisik Status (clustering)
        function getProgressFisikStatus(progressValue) {
            const progress = typeof progressValue === 'object' ? getProgressFisik(progressValue) : progressValue;
            if (progress === 0) return 'Belum Mulai';
            else if (progress <= 25) return 'Tahap Awal';
            else if (progress <= 50) return 'Tahap Menengah';
            else if (progress <= 75) return 'Tahap Lanjut';
            else if (progress < 100) return 'Hampir Selesai';
            else return 'Selesai';
        }
        
        // Smart getter untuk PIC Program (dari unit-kerja-kementrans.js)
        function getPICProgramInfo(picProgramCode) {
            if (!picProgramCode) return { nama: '-', singkatan: '' };
            
            try {
                // Check if UnitKerjaKementrans is available
                if (typeof window.UnitKerjaKementrans !== 'undefined') {
                    return window.UnitKerjaKementrans.getPICProgramInfo(picProgramCode);
                }
                
                // Fallback: just return the code
                return { nama: picProgramCode, singkatan: '' };
                } catch (error) {
                console.warn('⚠️ Error getting PIC Program info:', error);
                return { nama: picProgramCode, singkatan: '' };
            }
        }
        
        // Smart getter untuk Pagu Anggaran (backward compatibility)
        function getPaguAnggaran(item) {
            return item.paguAnggaran || item.nilaiAnggaran || 0;
        }
        
        // Smart getter untuk Nilai Kontrak (dengan fallback)
        function getNilaiKontrak(item) {
            return item.nilaiKontrak || getPaguAnggaran(item); // Fallback ke pagu
        }
        
        // Format currency
        function formatCurrency(amount) {
            if (!amount || amount === 0) return 'Rp 0';
            
            if (amount >= 1000000000000) {
                return `Rp ${(amount / 1000000000000).toFixed(1)} Triliun`;
            } else if (amount >= 1000000000) {
                return `Rp ${(amount / 1000000000).toFixed(1)} Milyar`;
            } else if (amount >= 1000000) {
                return `Rp ${(amount / 1000000).toFixed(1)} Juta`;
                    } else {
                return `Rp ${amount.toLocaleString('id-ID')}`;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Handle escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeEditModal();
            }
        });

        console.log('🚀 FINAL Progress Dashboard loaded - NO AUTO-REFRESH CONFLICTS');
    </script>
</body>
</html>

