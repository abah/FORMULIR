<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management Dashboard - Dashboard Monitoring Program dan Anggaran - Inspektorat Jenderal Kementrans</title>
    
    <!-- Favicon dan Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="logo/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="144x144" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="114x114" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="72x72" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="60x60" href="logo/logo.png">
    <link rel="apple-touch-icon" sizes="57x57" href="logo/logo.png">
    <link rel="shortcut icon" href="logo/logo.png">
    
    <!-- Meta Tags untuk Social Media dan WhatsApp -->
    <meta name="description" content="User Management Dashboard - Monitoring dan manajemen seluruh satker dan pengguna sistem Inspektorat Jenderal Kementerian Transmigrasi. Dashboard admin untuk kelola user dan akses sistem.">
    <meta name="keywords" content="User Management Dashboard, Admin, Itjen, Inspektorat Jenderal, Kementerian Transmigrasi, User, Satker, Management">
    <meta name="author" content="Inspektorat Jenderal Kementerian Transmigrasi">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:title" content="User Management Dashboard - Itjen Kementerian Transmigrasi RI">
    <meta property="og:description" content="Dashboard admin untuk monitoring dan manajemen seluruh satker dan pengguna sistem.">
    <meta property="og:image" content="logo/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Itjen Kementerian Transmigrasi RI">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="">
    <meta property="twitter:title" content="User Management Dashboard - Itjen Kementerian Transmigrasi RI">
    <meta property="twitter:description" content="Dashboard admin untuk monitoring dan manajemen user sistem.">
    <meta property="twitter:image" content="logo/logo.png">
    
    <!-- WhatsApp Meta Tags -->
    <meta property="og:image:alt" content="Logo Inspektorat Jenderal Kementerian Transmigrasi">
    <meta name="thumbnail" content="logo/logo.png">
    <meta name="thumbnail" content="logo/logo.png">
    
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --info: #64D2FF;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F2F2F7;
            --bg-tertiary: #E5E5EA;
            --label: #000000;
            --label-secondary: #3C3C43;
            --label-tertiary: #8E8E93;
            --gray-4: #D1D1D6;
            --gray-5: #E5E5EA;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-6: 24px;
            --space-8: 32px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'SF Pro Display', sans-serif;
            background: var(--bg-secondary);
            color: var(--label);
            line-height: 1.6;
            font-size: 16px;
        }

        /* ===== NAVIGATION ===== */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-5);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: var(--space-4) 0;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-6);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--label);
            font-weight: 600;
        }

        .navbar-icon {
            width: 40px;
            height: 40px;
            margin-right: var(--space-3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .navbar-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 0.9rem;
            color: var(--label-secondary);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #E32020;
            transform: translateY(-1px);
        }

        /* ===== MAIN CONTENT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        .page-header {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-2);
        }

        .page-subtitle {
            color: var(--label-secondary);
            font-size: 1.1rem;
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-3);
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.users { background: var(--primary); }
        .stat-icon.online { background: var(--success); }
        .stat-icon.provinces { background: var(--secondary); }
        .stat-icon.activity { background: var(--warning); }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--label);
            margin-bottom: var(--space-2);
        }

        .stat-label {
            color: var(--label-secondary);
            font-weight: 500;
        }

        /* ===== FILTERS ===== */
        .filters-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .filters-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--label);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 500;
            margin-bottom: var(--space-2);
            color: var(--label-secondary);
            font-size: 0.9rem;
        }

        .filter-input {
            padding: var(--space-3);
            border: 1px solid var(--gray-4);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--bg-primary);
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: var(--space-3);
            align-items: center;
        }

        .btn {
            padding: var(--space-3) var(--space-4);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn.primary {
            background: var(--primary);
            color: white;
        }

        .btn.success {
            background: var(--success);
            color: white;
        }

        .btn.warning {
            background: var(--warning);
            color: white;
        }

        .btn.secondary {
            background: var(--bg-tertiary);
            color: var(--label);
        }

        /* ===== USERS TABLE ===== */
        .users-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
        }

        .users-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--label);
        }

        .users-count {
            background: var(--primary);
            color: white;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-5);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .users-table th {
            background: var(--bg-secondary);
            padding: var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--label);
            border-bottom: 1px solid var(--gray-5);
            white-space: nowrap;
        }

        .users-table td {
            padding: var(--space-4);
            border-bottom: 1px solid var(--gray-5);
            vertical-align: middle;
        }

        .users-table tr:hover {
            background: rgba(0, 122, 255, 0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            margin-right: var(--space-3);
        }

        .user-info-cell {
            display: flex;
            align-items: center;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--label);
            margin-bottom: 2px;
        }

        .user-username {
            color: var(--label-secondary);
            font-size: 0.8rem;
        }

        .status-badge {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }

        .status-badge.online {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .status-badge.offline {
            background: rgba(142, 142, 147, 0.1);
            color: var(--label-tertiary);
            border: 1px solid rgba(142, 142, 147, 0.3);
        }

        .role-badge {
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
        }

        .role-badge.super-admin {
            background: rgba(88, 86, 214, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(88, 86, 214, 0.3);
        }

        .role-badge.satker-admin {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary);
            border: 1px solid rgba(0, 122, 255, 0.3);
        }

        .province-tag {
            background: var(--bg-secondary);
            color: var(--label-secondary);
            padding: 2px var(--space-2);
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 4px;
        }

        .last-login {
            color: var(--label-secondary);
            font-size: 0.8rem;
        }

        .never-login {
            color: var(--warning);
            font-weight: 500;
        }

        .login-count {
            background: var(--info);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
            }

            .navbar-content {
                padding: 0 var(--space-4);
            }

            .navbar-title {
                font-size: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .users-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-3);
            }

            .table-container {
                font-size: 0.8rem;
            }

            .users-table th,
            .users-table td {
                padding: var(--space-2);
            }
        }

        /* ===== LOADING & EMPTY STATES ===== */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-8);
            color: var(--label-secondary);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-8);
            color: var(--label-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="executive-dashboard.html" class="navbar-brand">
                <div class="navbar-icon">
                    <img src="logo/logo.png" alt="Logo Inspektorat Jenderal" style="width: 100%; height: 100%; object-fit: contain; border-radius: var(--radius-md);">
                </div>
                <div class="navbar-title">User Management</div>
            </a>
            <div class="navbar-actions">
                <div class="user-info">
                    <span>👑</span>
                    <span id="currentUserName">Super Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    🚪 Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header fade-in">
            <h1 class="page-title">👥 User Management Dashboard</h1>
            <p class="page-subtitle">
                Monitoring dan manajemen seluruh pengguna sistem di 38 provinsi Indonesia
            </p>
            
            <!-- Debug Section (temporary) -->
            <div id="debugSection" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 20px;">
                <h4 style="color: #856404; margin-bottom: 10px;">🔧 Debug Mode</h4>
                <button onclick="debugLogin()" style="background: #007AFF; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 4px; cursor: pointer;">
                    Login as Super Admin
                </button>
                <button onclick="debugCheck()" style="background: #34C759; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 4px; cursor: pointer;">
                    Check Session
                </button>
                <button onclick="debugClear()" style="background: #FF3B30; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 4px; cursor: pointer;">
                    Clear Session
                </button>
                <div id="debugOutput" style="background: #f8f9fa; padding: 15px; margin-top: 10px; border-radius: 8px; font-family: monospace; font-size: 13px; max-height: 200px; overflow-y: scroll; border: 1px solid #dee2e6; white-space: pre-wrap; line-height: 1.4;"></div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid fade-in">
            <div class="stat-card">
                <div class="stat-icon users">👥</div>
                <div class="stat-number" id="totalUsers">154</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon online">🟢</div>
                <div class="stat-number" id="onlineUsers">0</div>
                <div class="stat-label">Users Online</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon provinces">🏛️</div>
                <div class="stat-number" id="totalProvinces">38</div>
                <div class="stat-label">Provinsi</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon activity">📊</div>
                <div class="stat-number" id="totalLogins">0</div>
                <div class="stat-label">Total Logins</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section fade-in">
            <h3 class="filters-title">🔍 Filter & Search</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Search User</label>
                    <input type="text" class="filter-input" id="searchInput" 
                           placeholder="Cari nama, username, atau satker...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter Role</label>
                    <select class="filter-input" id="roleFilter">
                        <option value="">Semua Role</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="satker_admin">Satker Admin</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter Provinsi</label>
                    <select class="filter-input" id="provinceFilter">
                        <option value="">Semua Provinsi</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter Status</label>
                    <select class="filter-input" id="statusFilter">
                        <option value="">Semua Status</option>
                        <option value="pernah_login">Pernah Login</option>
                        <option value="belum_login">Belum Pernah Login</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn primary" onclick="applyFilters()">
                    🔍 Apply Filters
                </button>
                <button class="btn secondary" onclick="clearFilters()">
                    🔄 Clear Filters
                </button>
                <button class="btn success" onclick="exportUsers()">
                    📊 Export Data
                </button>
                <button class="btn warning" onclick="refreshData()">
                    🔄 Refresh
                </button>
            </div>
        </div>

        <!-- Users Table -->
        <div class="users-section fade-in">
            <div class="users-header">
                <h3 class="users-title">📋 Daftar Users</h3>
                <div class="users-count" id="filteredCount">154 users</div>
            </div>
            
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User Info</th>
                            <th>Role</th>
                            <th>Satker</th>
                            <th>Provinsi</th>
                            <th>Kabupaten</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Login Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="9" class="loading">
                                Loading users data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Load Dependencies -->
    <script src="indonesia-regions-complete.js"></script>
    <script src="satker-data-with-codes.js"></script>
    <script src="user-auth-system.js"></script>

    <!-- User Management Dashboard Logic -->
    <script>
        // ===================================================================
        // USER MANAGEMENT DASHBOARD LOGIC
        // ===================================================================

        let allUsers = [];
        let filteredUsers = [];
        let currentUser = null;
        let userAuthSystem = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        function initializeDashboard() {
            try {
                // Initialize auth system
                userAuthSystem = new UserAuthSystem();
                currentUser = userAuthSystem.getCurrentUser();

                console.log('🔍 Current user check:', currentUser);
                console.log('🔍 Session storage:', localStorage.getItem('satker_current_user'));

                // Check if user is logged in and has permission
                if (!currentUser) {
                    console.log('❌ No current user found');
                    
                    // Try to get user from localStorage directly
                    const directUser = localStorage.getItem('satker_current_user');
                    if (directUser) {
                        try {
                            currentUser = JSON.parse(directUser);
                            console.log('✅ Found user in direct localStorage:', currentUser.username);
                        } catch (e) {
                            console.log('❌ Error parsing direct user:', e.message);
                        }
                    }
                    
                    if (!currentUser) {
                        console.log('❌ Still no user found, redirecting to login');
                        alert('Anda harus login terlebih dahulu');
                        window.location.href = 'login.html';
                        return;
                    }
                }

                console.log('✅ User logged in:', currentUser.username, currentUser.role);

                // Check super admin permission (use manage_users or view_all_satker)
                let hasUserPermission = false;
                let hasAdminPermission = false;
                
                try {
                    hasUserPermission = userAuthSystem && userAuthSystem.hasPermission('manage_users');
                    hasAdminPermission = userAuthSystem && userAuthSystem.hasPermission('view_all_satker');
                } catch (e) {
                    console.log('⚠️ Error checking permissions via authSystem:', e.message);
                }
                
                // Fallback: check permissions directly from currentUser
                if (!hasUserPermission && !hasAdminPermission && currentUser.permissions) {
                    hasUserPermission = currentUser.permissions.includes('manage_users');
                    hasAdminPermission = currentUser.permissions.includes('view_all_satker');
                }
                
                const hasPermission = hasUserPermission || hasAdminPermission || currentUser.role === 'super_admin';
                
                console.log('🔍 Has manage_users permission:', hasUserPermission);
                console.log('🔍 Has view_all_satker permission:', hasAdminPermission);
                console.log('🔍 Is super_admin role:', currentUser.role === 'super_admin');
                console.log('🔍 Final permission:', hasPermission);
                console.log('🔍 User permissions:', currentUser.permissions);

                if (!hasPermission) {
                    alert('Anda tidak memiliki permission untuk mengakses user management');
                    
                    // Redirect to executive dashboard
                    window.location.href = 'executive-dashboard.html';
                    return;
                }

                // Load user info
                loadCurrentUserInfo();
                
                // Load all users data
                loadAllUsers();
                
                // Setup event listeners
                setupEventListeners();
                
                // Load provinces for filter
                loadProvinceFilter();

                console.log('👑 User Management Dashboard initialized');

            } catch (error) {
                console.error('Error initializing dashboard:', error);
                alert('Error initializing dashboard');
            }
        }

        function loadCurrentUserInfo() {
            if (currentUser) {
                document.getElementById('currentUserName').textContent = currentUser.fullName || currentUser.username || 'User';
            } else {
                document.getElementById('currentUserName').textContent = 'Unknown User';
            }
        }

        function loadAllUsers() {
            try {
                // Check if auth system is initialized
                if (!userAuthSystem) {
                    throw new Error('Auth system not initialized');
                }

                // Get all users from user auth system
                allUsers = userAuthSystem.getAllUsers() || [];
                
                // Get login statistics from audit logs
                const auditLogs = userAuthSystem.getAuditLogs() || [];
                
                // Process user data with login info
                allUsers.forEach(user => {
                    if (!user) return; // Skip null users
                    
                    // Get login statistics for this user
                    const userLogins = auditLogs.filter(log => 
                        log && log.username === user.username && log.action === 'login'
                    );
                    
                    user.loginCount = userLogins.length || 0;
                    user.lastLogin = userLogins.length > 0 ? 
                        userLogins[userLogins.length - 1].timestamp : null;
                    user.hasLoggedIn = userLogins.length > 0;
                    
                    // Add satker details
                    if (user.satkerCode && user.satkerCode !== 'SUPER_ADMIN' && window.completeSatkerData) {
                        const satker = window.completeSatkerData.find(s => s && s.code === user.satkerCode);
                        if (satker) {
                            user.satkerName = satker.name;
                            user.satkerProvinsi = satker.provinsi;
                            user.satkerKabupaten = satker.kabupaten;
                        }
                    }
                });

                // Update statistics
                updateStatistics();
                
                // Apply filters and display
                filteredUsers = [...allUsers];
                displayUsers();

                console.log(`📊 Loaded ${allUsers.length} users`);
                console.log('🔍 Sample user data:', allUsers.slice(0, 3));
                console.log('🔍 Auth system status:', !!userAuthSystem);
                console.log('🔍 Current user:', currentUser);

            } catch (error) {
                console.error('❌ Error loading users:', error);
                console.log('🔍 Auth system:', userAuthSystem);
                console.log('🔍 Available methods:', userAuthSystem ? Object.getOwnPropertyNames(Object.getPrototypeOf(userAuthSystem)) : 'N/A');
                showEmptyState('Error loading users data: ' + error.message);
            }
        }

        function updateStatistics() {
            const totalUsers = allUsers.length;
            const usersWithLogins = allUsers.filter(u => u.hasLoggedIn).length;
            const totalLogins = allUsers.reduce((sum, u) => sum + u.loginCount, 0);
            const uniqueProvinces = new Set(
                allUsers
                    .filter(u => u.satkerProvinsi)
                    .map(u => u.satkerProvinsi)
            ).size;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('onlineUsers').textContent = usersWithLogins;
            document.getElementById('totalProvinces').textContent = uniqueProvinces;
            document.getElementById('totalLogins').textContent = totalLogins;
        }

        function loadProvinceFilter() {
            try {
                const provinceFilter = document.getElementById('provinceFilter');
                if (!provinceFilter) {
                    console.error('Province filter element not found');
                    return;
                }

                const provinces = new Set();
                
                allUsers.forEach(user => {
                    if (user && user.satkerProvinsi) {
                        provinces.add(user.satkerProvinsi);
                    }
                });

                console.log('🔍 Found provinces:', Array.from(provinces));

                Array.from(provinces).sort().forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceFilter.appendChild(option);
                });

            } catch (error) {
                console.error('❌ Error loading province filter:', error);
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            if (filteredUsers.length === 0) {
                showEmptyState('No users found matching filters');
                return;
            }

            const rows = filteredUsers.map(user => createUserRow(user)).join('');
            tbody.innerHTML = rows;
            
            // Update filtered count
            document.getElementById('filteredCount').textContent = `${filteredUsers.length} users`;
        }

        function createUserRow(user) {
            const avatarInitial = user.fullName.charAt(0).toUpperCase();
            const roleDisplay = user.role === 'super_admin' ? 'Super Admin' : 'Satker Admin';
            const roleBadgeClass = user.role === 'super_admin' ? 'super-admin' : 'satker-admin';
            
            const statusBadge = user.hasLoggedIn ? 
                `<span class="status-badge online">Pernah Login</span>` :
                `<span class="status-badge offline">Belum Login</span>`;
            
            const lastLoginDisplay = user.lastLogin ? 
                `<span class="last-login">${formatDate(user.lastLogin)}</span>` :
                `<span class="last-login never-login">Belum pernah</span>`;

            const loginCountDisplay = user.loginCount > 0 ?
                `<span class="login-count">${user.loginCount}×</span>` :
                `<span class="login-count" style="background: var(--gray-4); color: var(--label-tertiary);">0×</span>`;

            return `
                <tr data-user-id="${user.username}">
                    <td>
                        <div class="user-info-cell">
                            <div class="user-avatar">${avatarInitial}</div>
                            <div class="user-details">
                                <div class="user-name">${user.fullName}</div>
                                <div class="user-username">@${user.username}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="role-badge ${roleBadgeClass}">${roleDisplay}</span>
                    </td>
                    <td>${user.satkerName || '-'}</td>
                    <td>
                        ${user.satkerProvinsi ? `<span class="province-tag">${user.satkerProvinsi}</span>` : '-'}
                    </td>
                    <td>${user.satkerKabupaten || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${lastLoginDisplay}</td>
                    <td>${loginCountDisplay}</td>
                    <td>
                        <button class="btn secondary" onclick="viewUserDetails('${user.username}')" 
                                style="padding: 4px 8px; font-size: 0.8rem;">
                            👁️ View
                        </button>
                    </td>
                </tr>
            `;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Hari ini ' + date.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else if (diffDays === 1) {
                return 'Kemarin';
            } else if (diffDays < 7) {
                return `${diffDays} hari lalu`;
            } else {
                return date.toLocaleDateString('id-ID');
            }
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            
            // Filter dropdowns
            document.getElementById('roleFilter').addEventListener('change', applyFilters);
            document.getElementById('provinceFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const provinceFilter = document.getElementById('provinceFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredUsers = allUsers.filter(user => {
                // Search filter
                if (searchTerm) {
                    const searchable = [
                        user.fullName,
                        user.username,
                        user.satkerName,
                        user.satkerProvinsi,
                        user.satkerKabupaten
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchable.includes(searchTerm)) {
                        return false;
                    }
                }

                // Role filter
                if (roleFilter && user.role !== roleFilter) {
                    return false;
                }

                // Province filter
                if (provinceFilter && user.satkerProvinsi !== provinceFilter) {
                    return false;
                }

                // Status filter
                if (statusFilter) {
                    if (statusFilter === 'pernah_login' && !user.hasLoggedIn) {
                        return false;
                    }
                    if (statusFilter === 'belum_login' && user.hasLoggedIn) {
                        return false;
                    }
                }

                return true;
            });

            displayUsers();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('provinceFilter').value = '';
            document.getElementById('statusFilter').value = '';
            
            filteredUsers = [...allUsers];
            displayUsers();
        }

        function exportUsers() {
            try {
                const exportData = filteredUsers.map(user => ({
                    'Nama Lengkap': user.fullName,
                    'Username': user.username,
                    'Role': user.role === 'super_admin' ? 'Super Admin' : 'Satker Admin',
                    'Satker': user.satkerName || '-',
                    'Provinsi': user.satkerProvinsi || '-',
                    'Kabupaten': user.satkerKabupaten || '-',
                    'Status Login': user.hasLoggedIn ? 'Pernah Login' : 'Belum Login',
                    'Jumlah Login': user.loginCount,
                    'Last Login': user.lastLogin ? new Date(user.lastLogin).toLocaleString('id-ID') : 'Belum pernah'
                }));

                const csvContent = convertToCSV(exportData);
                downloadCSV(csvContent, `users_export_${new Date().toISOString().split('T')[0]}.csv`);
                
                alert(`✅ Data ${filteredUsers.length} users berhasil di-export!`);

            } catch (error) {
                console.error('Export error:', error);
                alert('❌ Error saat export data');
            }
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function refreshData() {
            loadAllUsers();
            alert('✅ Data berhasil di-refresh!');
        }

        function viewUserDetails(username) {
            const user = allUsers.find(u => u.username === username);
            if (!user) return;

            const details = `
📋 USER DETAILS

👤 Informasi Dasar:
• Nama: ${user.fullName}
• Username: ${user.username}
• Role: ${user.role === 'super_admin' ? 'Super Admin' : 'Satker Admin'}

🏛️ Satker Info:
• Satker: ${user.satkerName || '-'}
• Kode: ${user.satkerCode || '-'}
• Provinsi: ${user.satkerProvinsi || '-'}
• Kabupaten: ${user.satkerKabupaten || '-'}

📊 Login Statistics:
• Status: ${user.hasLoggedIn ? 'Pernah Login' : 'Belum Pernah Login'}
• Jumlah Login: ${user.loginCount}×
• Last Login: ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('id-ID') : 'Belum pernah'}

📝 Permissions:
${user.permissions ? user.permissions.join(', ') : 'No specific permissions'}
            `;

            alert(details);
        }

        function showEmptyState(message) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <div class="empty-icon">👥</div>
                        <div>${message}</div>
                    </td>
                </tr>
            `;
        }

        function logout() {
            if (confirm('Yakin ingin logout?')) {
                userAuthSystem.logout();
                window.location.href = 'login.html';
            }
        }

        // Utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===================================================================
        // DEBUG FUNCTIONS
        // ===================================================================

        function debugLog(message) {
            const output = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function debugLogin() {
            debugLog('🔐 Creating super admin session...');
            
            try {
                const superAdmin = {
                    id: 'super_admin',
                    username: 'superadmin',
                    role: 'super_admin',
                    fullName: 'Super Administrator',
                    satkerCode: 'ALL',
                    satkerName: 'Kementerian Transmigrasi',
                    permissions: [
                        'view_all_satker',
                        'edit_all_satker', 
                        'manage_users',
                        'view_all_reports',
                        'system_admin',
                        'export_all_data'
                    ],
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem('satker_current_user', JSON.stringify(superAdmin));
                debugLog('✅ Super admin session created');
                debugLog('🔄 Reloading page in 2 seconds...');
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                debugLog(`❌ Login error: ${error.message}`);
            }
        }

        function debugCheck() {
            debugLog('📊 Checking session status...');
            
            try {
                const currentUser = localStorage.getItem('satker_current_user');
                const usersDb = localStorage.getItem('satker_users_db');
                
                debugLog(`Current User: ${currentUser ? 'EXISTS' : 'NOT FOUND'}`);
                debugLog(`Users DB: ${usersDb ? 'EXISTS' : 'NOT FOUND'}`);
                
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    debugLog(`User: ${user.username} (${user.role})`);
                    debugLog(`Permissions: ${user.permissions ? user.permissions.join(', ') : 'None'}`);
                }
                
                // Test auth system
                if (typeof UserAuthSystem !== 'undefined') {
                    debugLog('✅ UserAuthSystem available');
                    const auth = new UserAuthSystem();
                    const systemUser = auth.getCurrentUser();
                    debugLog(`System user: ${systemUser ? systemUser.username : 'None'}`);
                } else {
                    debugLog('❌ UserAuthSystem not available');
                }
                
            } catch (error) {
                debugLog(`❌ Check error: ${error.message}`);
            }
        }

        function debugClear() {
            debugLog('🗑️ Clearing session...');
            
            try {
                localStorage.removeItem('satker_current_user');
                debugLog('✅ Session cleared');
                debugLog('🔄 Reloading page in 2 seconds...');
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                debugLog(`❌ Clear error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
